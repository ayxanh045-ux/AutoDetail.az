<!DOCTYPE html>
<html lang="az">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yeni Payla≈üƒ±m | AutoDetail.az</title>
  <link href="./style.css?v=4" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
</head>

<body class="text-bg-dark d-flex flex-column min-vh-100 add-post-page">
  <header class="p-3 text-bg-dark">
    <div class="container">
      <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
        <a href="/" class="d-flex align-items-center mb-2 mb-lg-0 text-white text-decoration-none">
          <svg class="bi me-2" width="40" height="32" role="img" aria-label="Bootstrap">
            <use xlink:href="#bootstrap"></use>
          </svg>
        </a>
        <ul class="nav col-12 col-lg-auto me-lg-auto mb-2 justify-content-center mb-md-0">
          <li class="ma≈üƒ±n-logo"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
              class="bi bi-car-front-fill" viewBox="0 0 16 16">
              <path
                d="M2.52 3.515A2.5 2.5 0 0 1 4.82 2h6.362c1 0 1.904.596 2.298 1.515l.792 1.848c.075.175.21.319.38.404.5.25.855.715.965 1.262l.335 1.679q.05.242.049.49v.413c0 .814-.39 1.543-1 1.997V13.5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1-.5-.5v-1.338c-1.292.048-2.745.088-4 .088s-2.708-.04-4-.088V13.5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1-.5-.5v-1.892c-.61-.454-1-1.183-1-1.997v-.413a2.5 2.5 0 0 1 .049-.49l.335-1.68c.11-.546.465-1.012.964-1.261a.8.8 0 0 0 .381-.404l.792-1.848ZM3 10a1 1 0 1 0 0-2 1 1 0 0 0 0 2m10 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2M6 8a1 1 0 0 0 0 2h4a1 1 0 1 0 0-2zM2.906 5.189a.51.51 0 0 0 .497.731c.91-.073 3.35-.17 4.597-.17s3.688.097 4.597.17a.51.51 0 0 0 .497-.731l-.956-1.913A.5.5 0 0 0 11.691 3H4.309a.5.5 0 0 0-.447.276L2.906 5.19Z" />
            </svg></li>
          <li><a href="./index.html" class="nav-link px-2 text-white">Home</a></li>
          <li><a href="./profile.html" class="nav-link px-2 text-white">Profil</a></li>
          <li><a href="./about.html" class="nav-link px-2 text-white">About</a></li>
          <li><a href="./favorites.html" class="nav-link px-2 text-white favorites-only d-none">Sevimlil…ôrim</a></li>
          <li><a href="./admin.html" class="nav-link px-2 text-white admin-only d-none">Admin</a></li>
        </ul>
        <form class="col-12 col-lg-auto mb-3 mb-lg-0 me-lg-3" role="search">
          <input type="search" class="form-control form-control-dark text-bg-dark" placeholder="search.."
            aria-label="Search">
        </form>
        <div class="language-switcher ms-lg-2 me-lg-3">
          <button type="button" class="btn btn-outline-light btn-sm lang-btn" data-lang="az">üá¶üáø</button>
          <button type="button" class="btn btn-outline-light btn-sm lang-btn" data-lang="en">üá¨üáß</button>
          <button type="button" class="btn btn-outline-light btn-sm lang-btn" data-lang="ru">üá∑üá∫</button>
        </div>
        <div class="add-post-center">
          <button id="add-post-btn" type="button" class="btn btn-warning btn-sm">+</button>
        </div>
      </div>
    </div>
  </header>
  <hr class="border-light border-2 opacity-75 my-0">

  <main class="container py-5 flex-grow-1">
    <div class="row justify-content-center">
      <div class="col-lg-7">
        <div class="card bg-dark text-white border-light shadow-lg">
          <div class="card-body p-4">
            <h1 class="h4 mb-3" data-i18n="add_title">Yeni payla≈üƒ±m</h1>
            <form id="add-post-form">
              <div class="step-indicator mb-3">
                <div class="step-dot active"></div>
                <div class="step-dot"></div>
                <div class="step-dot"></div>
              </div>
              <div class="step-section active" data-step="0">
                <div class="mb-3 brand-block">
                <label class="form-label" for="car-brand" data-i18n="label_brand">Ma≈üƒ±nƒ±n markasƒ±</label>
                <div class="suggest-wrap">
                  <input class="form-control" id="car-brand" placeholder="Markanƒ± yazƒ±n..." required>
                  <div id="brand-suggest" class="suggest-dropdown d-none"></div>
                </div>
                </div>
                <div class="mb-3 model-block">
                <label class="form-label" for="car-model" data-i18n="label_model">Ma≈üƒ±nƒ±n modeli</label>
                <div class="suggest-wrap">
                  <input class="form-control" id="car-model" placeholder="Modeli yazƒ±n..." required>
                  <div id="model-suggest" class="suggest-dropdown d-none"></div>
                </div>
                </div>
                <div class="mb-3 year-block">
                <label class="form-label" for="car-year" data-i18n="label_year">Ma≈üƒ±nƒ±n ili</label>
                <select class="form-select" id="car-year" required>
                  <option value=\"\">Se√ßin...</option>
                </select>
                </div>
                <div class="mb-3 color-block">
                <label class="form-label" for="car-color" data-i18n="label_color">R…ông</label>
                <select class="form-select" id="car-color" required>
                  <option value=\"\">Se√ßin...</option>
                </select>
                </div>
              </div>
              <div class="step-section" data-step="1">
                <div class="mb-3">
                <label class="form-label" for="part-category" data-i18n="label_part_category">Ehtiyat hiss…ôsinin b√∂lm…ôsi</label>
                <select class="form-select" id="part-category" required>
                  <option value=\"\">Se√ßin...</option>
                </select>
                </div>
                <div class="mb-3">
                <label class="form-label" for="part-type" data-i18n="label_part_type">Ehtiyat hiss…ôsinin n√∂v√º</label>
                <select class="form-select" id="part-type" required>
                  <option value=\"\">Se√ßin...</option>
                </select>
                </div>
              </div>
              <div class="step-section" data-step="2">
                <div class="mb-3">
                <label class="form-label" for="post-title" data-i18n="label_title">Ba≈ülƒ±q</label>
                <input class="form-control" id="post-title" type="text" placeholder="M…ôs: Ehtiyat hiss…ô" />
                </div>
                <div class="mb-3">
                <label class="form-label" for="post-image" data-i18n="label_image">≈û…ôkil</label>
                <input class="form-control" id="post-image" type="file" accept="image/*" multiple />
                </div>
                <div class="mb-3">
                <label class="form-label" for="post-price" data-i18n="label_price">Qiym…ôt</label>
                <input class="form-control" id="post-price" type="number" step="0.01" min="0" placeholder="0.00" />
                </div>
                <div class="mb-3">
                <label class="form-label" for="post-price-currency" data-i18n="label_currency">Valyuta</label>
                <select class="form-select" id="post-price-currency">
                  <option value="AZN">Manat</option>
                  <option value="USD">Dollar</option>
                  <option value="EUR">Euro</option>
                </select>
                </div>
                <div class="mb-3">
                <label class="form-label" for="post-desc" data-i18n="label_desc">M…ôlumat</label>
                <textarea class="form-control" id="post-desc" rows="4"
                  placeholder="M√º≈üt…ôri √º√ß√ºn m…ôlumatƒ± yazƒ±n..."></textarea>
                </div>
              </div>
              <div class="d-flex gap-2 mt-2">
                <button id="step-prev" class="btn btn-outline-light" type="button">Geri</button>
                <button id="step-next" class="btn btn-warning" type="button">N√∂vb…ôti</button>
                <button id="submit-post" class="btn btn-warning ms-auto d-none" type="button" data-i18n="btn_submit">Payla≈ü</button>
              </div>
              <div id="post-message" class="mt-3"></div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </main>
  <div id="app-toast" class="app-toast"></div>

  <hr class="border-light border-2 opacity-75 my-0">
  <footer class="bg-dark text-white py-3 mt-auto">
    <div class="container">
            <div class="footer-contact mb-3">
        <div class="footer-contact-label">∆èlaq…ô √º√ß√ºn:</div>
        <div class="footer-contact-row">
          <input class="footer-contact-input form-control form-control-dark text-bg-dark" placeholder="Emailinizi yazƒ±n">
          <input class="footer-contact-message form-control form-control-dark text-bg-dark" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n">
          <button class="footer-contact-send btn btn-warning">G√∂nd…ôr</button>
        </div>
      </div>
      <ul class="nav justify-content-center border-bottom pb-0 mb-0">
        <li class="nav-item"><a href="./index.html" class="nav-link px-2 text-white">Home</a></li>
        <li class="nav-item"><a href="./profile.html" class="nav-link px-2 text-white">Profil</a></li>
        <li class="nav-item"><a href="./about.html" class="nav-link px-2 text-white">About</a></li>
      </ul>
      <p class="text-center mb-0">¬© 2026 AutoDetail.az</p>
    </div>
  </footer>

  <script>
    const translations = {
      az: {
        add_title: 'Yeni payla≈üƒ±m',
        label_brand: 'Ma≈üƒ±nƒ±n markasƒ±',
        label_model: 'Ma≈üƒ±nƒ±n modeli',
        label_year: 'Ma≈üƒ±nƒ±n ili',
        label_color: 'R…ông',
        other_option: 'Dig…ôr',
        other_placeholder_brand: 'M…ôs: Skoda',
        other_placeholder_model: 'M…ôs: Octavia',
        other_placeholder_year: 'M…ôs: 2019',
        label_part_category: 'Ehtiyat hiss…ôsinin b√∂lm…ôsi',
        label_part_type: 'Ehtiyat hiss…ôsinin n√∂v√º',
        label_title: 'Ba≈ülƒ±q',
        label_image: '≈û…ôkil',
        label_desc: 'M…ôlumat',
        label_price: 'Qiym…ôt',
        label_currency: 'Valyuta',
        btn_submit: 'Payla≈ü',
        msg_fill: 'Z…ôhm…ôt olmasa b√ºt√ºn sah…ôl…ôri doldurun.',
        msg_error: 'X…ôta ba≈ü verdi.',
        msg_server: 'Server…ô qo≈üulmaq olmadƒ±.',
        select_placeholder: 'Se√ßin...'
      },
      en: {
        add_title: 'New post',
        label_brand: 'Car brand',
        label_model: 'Car model',
        label_year: 'Car year',
        label_color: 'Color',
        other_option: 'Other',
        other_placeholder_brand: 'e.g. Skoda',
        other_placeholder_model: 'e.g. Octavia',
        other_placeholder_year: 'e.g. 2019',
        label_part_category: 'Spare part category',
        label_part_type: 'Spare part type',
        label_title: 'Title',
        label_image: 'Image',
        label_desc: 'Description',
        label_price: 'Price',
        label_currency: 'Currency',
        btn_submit: 'Post',
        msg_fill: 'Please fill in all fields.',
        msg_error: 'Something went wrong.',
        msg_server: 'Could not connect to server.',
        select_placeholder: 'Select...'
      },
      ru: {
        add_title: '–ù–æ–≤—ã–π –ø–æ—Å—Ç',
        label_brand: '–ú–∞—Ä–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è',
        label_model: '–ú–æ–¥–µ–ª—å –∞–≤—Ç–æ–º–æ–±–∏–ª—è',
        label_year: '–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞',
        label_color: '–¶–≤–µ—Ç',
        other_option: '–î—Ä—É–≥–æ–µ',
        other_placeholder_brand: '–ù–∞–ø—Ä: Skoda',
        other_placeholder_model: '–ù–∞–ø—Ä: Octavia',
        other_placeholder_year: '–ù–∞–ø—Ä: 2019',
        label_part_category: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∑–∞–ø—á–∞—Å—Ç–∏',
        label_part_type: '–¢–∏–ø –∑–∞–ø—á–∞—Å—Ç–∏',
        label_title: '–ó–∞–≥–æ–ª–æ–≤–æ–∫',
        label_image: '–§–æ—Ç–æ',
        label_desc: '–û–ø–∏—Å–∞–Ω–∏–µ',
        label_price: '–¶–µ–Ω–∞',
        label_currency: '–í–∞–ª—é—Ç–∞',
        btn_submit: '–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å',
        msg_fill: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è.',
        msg_error: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.',
        msg_server: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É.',
        select_placeholder: '–í—ã–±–µ—Ä–∏—Ç–µ...'
      }
    };

    let currentLang = localStorage.getItem('siteLang') || 'az';
    const getOtherLabel = () => {
      const dict = translations[currentLang] || translations.az;
      return dict.other_option || 'Dig…ôr';
    };
    const colorTranslations = {
      az: {
        'Aƒü': 'Aƒü',
        'Qara': 'Qara',
        'G√ºm√º≈ü': 'G√ºm√º≈ü',
        'Boz': 'Boz',
        'Qƒ±rmƒ±zƒ±': 'Qƒ±rmƒ±zƒ±',
        'Mavi': 'Mavi',
        'Ya≈üƒ±l': 'Ya≈üƒ±l',
        'Sarƒ±': 'Sarƒ±',
        'Q…ôhv…ôyi': 'Q…ôhv…ôyi',
        'Bej': 'Bej',
        'Narƒ±ncƒ±': 'Narƒ±ncƒ±',
        'B…ôn√∂v≈ü…ôyi': 'B…ôn√∂v≈ü…ôyi',
        'Bordo': 'Bordo',
        'G√∂y': 'G√∂y',
        '≈ûampan': '≈ûampan',
        'Turkuaz': 'Turkuaz'
      },
      en: {
        'Aƒü': 'White',
        'Qara': 'Black',
        'G√ºm√º≈ü': 'Silver',
        'Boz': 'Gray',
        'Qƒ±rmƒ±zƒ±': 'Red',
        'Mavi': 'Blue',
        'Ya≈üƒ±l': 'Green',
        'Sarƒ±': 'Yellow',
        'Q…ôhv…ôyi': 'Brown',
        'Bej': 'Beige',
        'Narƒ±ncƒ±': 'Orange',
        'B…ôn√∂v≈ü…ôyi': 'Purple',
        'Bordo': 'Burgundy',
        'G√∂y': 'Navy',
        '≈ûampan': 'Champagne',
        'Turkuaz': 'Turquoise'
      },
      ru: {
        'Aƒü': '–ë–µ–ª—ã–π',
        'Qara': '–ß–µ—Ä–Ω—ã–π',
        'G√ºm√º≈ü': '–°–µ—Ä–µ–±—Ä–∏—Å—Ç—ã–π',
        'Boz': '–°–µ—Ä—ã–π',
        'Qƒ±rmƒ±zƒ±': '–ö—Ä–∞—Å–Ω—ã–π',
        'Mavi': '–°–∏–Ω–∏–π',
        'Ya≈üƒ±l': '–ó–µ–ª—ë–Ω—ã–π',
        'Sarƒ±': '–ñ—ë–ª—Ç—ã–π',
        'Q…ôhv…ôyi': '–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π',
        'Bej': '–ë–µ–∂–µ–≤—ã–π',
        'Narƒ±ncƒ±': '–û—Ä–∞–Ω–∂–µ–≤—ã–π',
        'B…ôn√∂v≈ü…ôyi': '–§–∏–æ–ª–µ—Ç–æ–≤—ã–π',
        'Bordo': '–ë–æ—Ä–¥–æ–≤—ã–π',
        'G√∂y': '–¢—ë–º–Ω–æ-—Å–∏–Ω–∏–π',
        '≈ûampan': '–®–∞–º–ø–∞–Ω—å',
        'Turkuaz': '–ë–∏—Ä—é–∑–æ–≤—ã–π'
      }
    };
    const baseColors = [
      'Aƒü',
      'Qara',
      'G√ºm√º≈ü',
      'Boz',
      'Qƒ±rmƒ±zƒ±',
      'Mavi',
      'Ya≈üƒ±l',
      'Sarƒ±',
      'Q…ôhv…ôyi',
      'Bej',
      'Narƒ±ncƒ±',
      'B…ôn√∂v≈ü…ôyi',
      'Bordo',
      'G√∂y',
      '≈ûampan',
      'Turkuaz'
    ];
    const getSelectPlaceholder = () => {
      const dict = translations[currentLang] || translations.az;
      return dict.select_placeholder || 'Se√ßin...';
    };
    const applyTranslations = () => {
      const dict = translations[currentLang] || translations.az;
      document.documentElement.lang = currentLang;
      document.querySelectorAll('[data-i18n]').forEach((el) => {
        const key = el.getAttribute('data-i18n');
        if (dict[key]) {
          el.textContent = dict[key];
        }
      });
    };
    applyTranslations();

    const addPostBtn = document.getElementById('add-post-btn');
    if (addPostBtn) {
      addPostBtn.addEventListener('click', () => {
        const currentUser = localStorage.getItem('currentUser');
        if (!currentUser) {
          window.location.href = './login.html';
          return;
        }
      });
    }

    const adminLinks = document.querySelectorAll('.admin-only');
    const favoritesLinks = document.querySelectorAll('.favorites-only');
    const currentUserForAdmin = localStorage.getItem('currentUser');
    if (currentUserForAdmin) {
      const email = JSON.parse(currentUserForAdmin).email;
      favoritesLinks.forEach((el) => el.classList.remove('d-none'));
      fetch(`/api/profile?email=${encodeURIComponent(email)}`)
        .then((res) => res.json())
        .then((data) => {
          if (data.user && String(data.user.role).toLowerCase() === 'admin') {
            adminLinks.forEach((el) => el.classList.remove('d-none'));
          }
        })
        .catch(() => {});
    }
  </script>
  <script>
    const formEl = document.getElementById('add-post-form');
    const brandSelect = document.getElementById('car-brand');
    const modelSelect = document.getElementById('car-model');
    const yearSelect = document.getElementById('car-year');
    const colorSelect = document.getElementById('car-color');
    const brandSuggest = document.getElementById('brand-suggest');
    const modelSuggest = document.getElementById('model-suggest');
    const submitPost = document.getElementById('submit-post');
    const messageEl = document.getElementById('post-message');
    const toastEl = document.getElementById('app-toast');
    const showToast = (text, type) => {
      if (!toastEl) return;
      toastEl.textContent = text;
      toastEl.className = `app-toast show ${type || ''}`.trim();
      clearTimeout(showToast.timer);
      showToast.timer = setTimeout(() => {
        toastEl.className = 'app-toast';
      }, 2000);
    };
    const partCategorySelect = document.getElementById('part-category');
    const partTypeSelect = document.getElementById('part-type');
    const stepSections = Array.from(document.querySelectorAll('.step-section'));
    const stepDots = Array.from(document.querySelectorAll('.step-dot'));
    const stepPrev = document.getElementById('step-prev');
    const stepNext = document.getElementById('step-next');

    const updateOtherPlaceholders = () => {};

    modelSelect.dataset.animate = '1';
    colorSelect.dataset.animate = '1';

    let currentStep = 0;
    const showStep = (idx) => {
      currentStep = idx;
      stepSections.forEach((section, i) => {
        section.classList.toggle('active', i === idx);
      });
      stepDots.forEach((dot, i) => {
        dot.classList.toggle('active', i <= idx);
      });
      if (stepPrev) stepPrev.disabled = idx === 0;
      if (stepNext) stepNext.classList.toggle('d-none', idx === stepSections.length - 1);
      if (submitPost) submitPost.classList.toggle('d-none', idx !== stepSections.length - 1);
    };

    const getValueOrOther = (select, otherInput) => {
      if (select.value === '__other__') return (otherInput.value || '').trim();
      return select.value;
    };

    const validateStep = (idx) => {
      const dict = translations[currentLang] || translations.az;
      messageEl.textContent = '';
      messageEl.className = 'mt-3';
      if (idx === 0) {
        const brand = brandSelect.value.trim();
        const model = modelSelect.value.trim();
        const year = yearSelect.value;
        const color = colorSelect.value;
        if (!brand || !model || !year || !color) {
          messageEl.textContent = dict.msg_fill;
          messageEl.className = 'mt-3 text-danger';
          return false;
        }
      }
      if (idx === 1) {
        if (!partCategorySelect.value || !partTypeSelect.value) {
          messageEl.textContent = dict.msg_fill;
          messageEl.className = 'mt-3 text-danger';
          return false;
        }
      }
      return true;
    };

    if (stepPrev) {
      stepPrev.addEventListener('click', () => {
        if (currentStep > 0) showStep(currentStep - 1);
      });
    }
    if (stepNext) {
      stepNext.addEventListener('click', () => {
        if (!validateStep(currentStep)) return;
        if (currentStep < stepSections.length - 1) showStep(currentStep + 1);
      });
    }
    showStep(0);

    const clearOptions = (select) => {
      select.innerHTML = `<option value=\"\">${getSelectPlaceholder()}</option>`;
    };

    const unique = (items) => Array.from(new Set(items));

    const formatColorLabel = (value) => {
      const map = colorTranslations[currentLang] || colorTranslations.az;
      return map[value] || value;
    };

    const populateSelect = (select, values, formatter) => {
      clearOptions(select);
      values.forEach((value) => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = formatter ? formatter(value) : value;
        select.appendChild(option);
      });
    };

    const updateOtherOption = () => {};

    const updateColorOptionLabels = () => {
      if (!colorSelect) return;
      Array.from(colorSelect.options || []).forEach((opt) => {
        if (!opt.value || opt.value === '__other__') return;
        opt.textContent = formatColorLabel(opt.value);
      });
    };

    const updateSelectPlaceholders = () => {
      [yearSelect, colorSelect, partCategorySelect, partTypeSelect].forEach((select) => {
        if (!select) return;
        const firstOption = select.options && select.options[0];
        if (firstOption && firstOption.value === '') {
          firstOption.textContent = getSelectPlaceholder();
        }
      });
      updateColorOptionLabels();
    };

    let carsData = [];
    let modelsData = [];
    let brandOptions = [];
    let modelOptions = [];
    const defaultBrands = ['Mercedes-Benz','BMW','Toyota','Hyundai','Kia','LADA','Nissan','Volkswagen','Opel','Chevrolet','Ford','Honda','Lexus','Audi','Mazda'];
    const getBrandSource = () => {
      if (brandOptions.length) return brandOptions;
      if (carsData.length) return unique(carsData.map((c) => c.brand));
      if (modelsData.length) return unique(modelsData.map((c) => c.brand));
      return defaultBrands;
    };

    const getModelSource = () => {
      if (modelOptions.length) return modelOptions;
      if (modelsData.length) return unique(modelsData.map((c) => c.model));
      if (carsData.length) return unique(carsData.map((c) => c.model));
      return [];
    };

    const updateSuggestState = () => {
      if (!formEl) return;
      const brandOpen = brandSuggest && !brandSuggest.classList.contains('d-none');
      const modelOpen = modelSuggest && !modelSuggest.classList.contains('d-none');
      formEl.classList.toggle('brand-suggest-open', !!brandOpen);
      formEl.classList.toggle('model-suggest-open', !!modelOpen);
    };

    const renderSuggest = (box, items) => {
      if (!box) return;
      if (!items.length) {
        box.classList.add('d-none');
        box.innerHTML = '';
        updateSuggestState();
        return;
      }
      box.innerHTML = items.map((item) => `<button type="button" class="suggest-item">${item}</button>`).join('');
      box.classList.remove('d-none');
      updateSuggestState();
    };

    fetch('/api/cars/models')
      .then((res) => res.json())
      .then((data) => {
        modelsData = data.models || [];
        const brands = unique(modelsData.map((c) => c.brand));
        brandOptions = brands.slice();
        modelOptions = unique(modelsData.map((c) => c.model));
      })
      .catch(() => {
      });

    fetch('/api/cars')
      .then((res) => res.json())
      .then((data) => {
        carsData = data.cars || [];
        const brands = unique(carsData.map((c) => c.brand));
        if (!brandOptions.length) brandOptions = brands.slice();
        if (!modelOptions.length) {
          modelOptions = unique(carsData.map((c) => c.model));
        }
      })
      .catch(() => {});


    const populateYearRange = () => {
      yearSelect.innerHTML = `<option value=\"\">${getSelectPlaceholder()}</option>`;
      for (let y = 2026; y >= 1995; y -= 1) {
        const option = document.createElement('option');
        option.value = String(y);
        option.textContent = String(y);
        yearSelect.appendChild(option);
      }
    };

    populateYearRange();

    brandSelect.addEventListener('input', () => {
      const brand = String(brandSelect.value || '').trim();
      if (!brand) {
        populateYearRange();
        populateSelect(colorSelect, baseColors, formatColorLabel);
        return;
      }
      const modelFiltered = modelsData.filter((c) => c.brand === brand);
      const models = unique(modelFiltered.map((c) => c.model));
      if (!models.length) {
        const fallbackModels = carsData.filter((c) => c.brand === brand).map((c) => c.model);
        models.push(...unique(fallbackModels));
      }
      const filtered = carsData.filter((c) => c.brand === brand);
      const colors = unique(baseColors.concat(filtered.map((c) => c.color)));
      modelOptions = models;
      renderSuggest(brandSuggest, getBrandSource().filter((b) => b.toLowerCase().includes(brand.toLowerCase())).slice(0, 8));
      renderSuggest(modelSuggest, models.slice(0, 8));
      populateYearRange();
      populateSelect(colorSelect, colors, formatColorLabel);
    });

    modelSelect.addEventListener('input', () => {
      const brand = String(brandSelect.value || '').trim();
      const model = String(modelSelect.value || '').trim();
      const source = modelOptions.length ? modelOptions : getModelSource();
      renderSuggest(modelSuggest, source.filter((m) => m.toLowerCase().includes(model.toLowerCase())).slice(0, 8));
      const filtered = carsData.filter((c) => c.brand === brand && c.model === model);
      const colors = unique(baseColors.concat(filtered.map((c) => c.color)));
      populateYearRange();
      populateSelect(colorSelect, colors, formatColorLabel);
    });

    yearSelect.addEventListener('change', () => {
      const brand = brandSelect.value.trim();
      const model = modelSelect.value.trim();
      const year = Number(yearSelect.value);
      const filtered = carsData.filter((c) => c.brand === brand && c.model === model && c.year === year);
      const colors = unique(baseColors.concat(filtered.map((c) => c.color)));
      populateSelect(colorSelect, colors, formatColorLabel);
    });

    colorSelect.addEventListener('change', () => {});

    if (brandSuggest) {
      brandSuggest.addEventListener('click', (e) => {
        const btn = e.target.closest('.suggest-item');
        if (!btn) return;
        brandSelect.value = btn.textContent;
        brandSelect.dispatchEvent(new Event('input'));
        brandSuggest.classList.add('d-none');
        updateSuggestState();
      });
    }

    if (modelSuggest) {
      modelSuggest.addEventListener('click', (e) => {
        const btn = e.target.closest('.suggest-item');
        if (!btn) return;
        modelSelect.value = btn.textContent;
        modelSelect.dispatchEvent(new Event('input'));
        modelSuggest.classList.add('d-none');
        updateSuggestState();
      });
    }

    document.addEventListener('click', (e) => {
      if (brandSuggest && !brandSuggest.contains(e.target) && e.target !== brandSelect) {
        brandSuggest.classList.add('d-none');
        updateSuggestState();
      }
      if (modelSuggest && !modelSuggest.contains(e.target) && e.target !== modelSelect) {
        modelSuggest.classList.add('d-none');
        updateSuggestState();
      }
    });

    let partsData = [];
    fetch('/api/parts')
      .then((res) => res.json())
      .then((data) => {
        partsData = data.parts || [];
        const grouped = partsData.reduce((acc, item) => {
          acc[item.category] = acc[item.category] || [];
          acc[item.category].push(item.name);
          return acc;
        }, {});
        partCategorySelect.innerHTML = `<option value=\"\">${getSelectPlaceholder()}</option>`;
        Object.keys(grouped).forEach((category) => {
          const option = document.createElement('option');
          option.value = category;
          option.textContent = category;
          partCategorySelect.appendChild(option);
        });
        partTypeSelect.innerHTML = `<option value=\"\">${getSelectPlaceholder()}</option>`;
      })
      .catch(() => {
        partCategorySelect.innerHTML = `<option value=\"\">${getSelectPlaceholder()}</option>`;
        partTypeSelect.innerHTML = `<option value=\"\">${getSelectPlaceholder()}</option>`;
      });

    partCategorySelect.addEventListener('change', () => {
      const category = partCategorySelect.value;
      const filtered = partsData.filter((p) => p.category === category);
      const names = unique(filtered.map((p) => p.name));
      partTypeSelect.innerHTML = `<option value=\"\">${getSelectPlaceholder()}</option>`;
      names.forEach((name) => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        partTypeSelect.appendChild(option);
      });
    });

    document.querySelectorAll('.lang-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        currentLang = btn.dataset.lang;
        localStorage.setItem('siteLang', currentLang);
        applyTranslations();
        updateSelectPlaceholders();
        updateOtherPlaceholders();
      });
    });


    submitPost.addEventListener('click', async () => {
      messageEl.textContent = '';
      if (!validateStep(0) || !validateStep(1)) {
        return;
      }
      const currentUser = localStorage.getItem('currentUser');
      if (!currentUser) {
        window.location.href = './login.html';
        return;
      }

      const email = JSON.parse(currentUser).email;
      const brand = brandSelect.value.trim();
      const model = modelSelect.value.trim();
      const year = yearSelect.value;
      const color = colorSelect.value;

      if (!brand || !model || !year || !color) {
        const dict = translations[currentLang] || translations.az;
        messageEl.textContent = dict.msg_fill;
        messageEl.className = 'mt-3 text-danger';
        showToast(messageEl.textContent, 'error');
        return;
      }

      const title = document.getElementById('post-title').value.trim();
      const desc = document.getElementById('post-desc').value.trim();
      const partType = partTypeSelect.value.trim();
      const imageFiles = Array.from(document.getElementById('post-image').files || []);
      const price = document.getElementById('post-price').value;
      const priceCurrency = document.getElementById('post-price-currency').value;

      const formData = new FormData();
      formData.append('email', email);
      formData.append('title', title || 'Payla≈üƒ±m');
      formData.append('description', desc);
      formData.append('part_type', partType);
      formData.append('car_brand', brand);
      formData.append('car_model', model);
      formData.append('car_year', year);
      formData.append('car_color', color);
      formData.append('price', price);
      formData.append('price_currency', priceCurrency);
      imageFiles.forEach((file) => {
        formData.append('images', file);
      });

      try {
        const response = await fetch('/api/posts', {
          method: 'POST',
          body: formData
        });
        const data = await response.json();
        if (!response.ok) {
          const dict = translations[currentLang] || translations.az;
          messageEl.textContent = data.error || dict.msg_error;
          messageEl.className = 'mt-3 text-danger';
          showToast(messageEl.textContent, 'error');
          return;
        }
        window.location.href = `./post.html?id=${data.id}`;
      } catch (err) {
        const dict = translations[currentLang] || translations.az;
        messageEl.textContent = dict.msg_server;
        messageEl.className = 'mt-3 text-danger';
        showToast(messageEl.textContent, 'error');
      }
    });
  </script>
  <script src="./assets/contact.js?v=4"></script>
</body>

</html>
