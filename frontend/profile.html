<!DOCTYPE html>
<html lang="az">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profil | AutoDetail.az</title>
  <link href="style.css?v=8" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
</head>

<body class="text-bg-dark d-flex flex-column min-vh-100">
  <header class="p-3 text-bg-dark">
    <div class="container">
      <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
        <a href="/" class="d-flex align-items-center mb-2 mb-lg-0 text-white text-decoration-none">
          <svg class="bi me-2" width="40" height="32" role="img" aria-label="Bootstrap">
            <use xlink:href="#bootstrap"></use>
          </svg>
        </a>
        <ul class="nav col-12 col-lg-auto me-lg-auto mb-2 justify-content-center mb-md-0">
          <li class="ma≈üƒ±n-logo"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
              class="bi bi-car-front-fill" viewBox="0 0 16 16">
              <path
                d="M2.52 3.515A2.5 2.5 0 0 1 4.82 2h6.362c1 0 1.904.596 2.298 1.515l.792 1.848c.075.175.21.319.38.404.5.25.855.715.965 1.262l.335 1.679q.05.242.049.49v.413c0 .814-.39 1.543-1 1.997V13.5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1-.5-.5v-1.338c-1.292.048-2.745.088-4 .088s-2.708-.04-4-.088V13.5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1-.5-.5v-1.892c-.61-.454-1-1.183-1-1.997v-.413a2.5 2.5 0 0 1 .049-.49l.335-1.68c.11-.546.465-1.012.964-1.261a.8.8 0 0 0 .381-.404l.792-1.848ZM3 10a1 1 0 1 0 0-2 1 1 0 0 0 0 2m10 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2M6 8a1 1 0 0 0 0 2h4a1 1 0 1 0 0-2zM2.906 5.189a.51.51 0 0 0 .497.731c.91-.073 3.35-.17 4.597-.17s3.688.097 4.597.17a.51.51 0 0 0 .497-.731l-.956-1.913A.5.5 0 0 0 11.691 3H4.309a.5.5 0 0 0-.447.276L2.906 5.19Z" />
            </svg></li>
          <li><a href="./index.html" class="nav-link px-2 text-white" data-i18n="nav_home">Home</a></li>
          <li><a href="./profile.html" class="nav-link px-2 text-secondary" data-i18n="nav_profile">Profil</a></li>
          <li><a href="./about.html" class="nav-link px-2 text-white" data-i18n="nav_about">About</a></li>
          <li><a href="./favorites.html" class="nav-link px-2 text-white favorites-only d-none">Sevimlil…ôrim</a></li>
          <li><a href="./admin.html" class="nav-link px-2 text-white admin-only d-none">Admin</a></li>
        </ul>
        <form class="col-12 col-lg-auto mb-3 mb-lg-0 me-lg-3" role="search">
          <input type="search" class="form-control form-control-dark text-bg-dark" placeholder="search.."
            aria-label="Search">
        </form>
        <div class="language-switcher ms-lg-2 me-lg-3">
          <button type="button" class="btn btn-outline-light btn-sm lang-btn" data-lang="az">üá¶üáø</button>
          <button type="button" class="btn btn-outline-light btn-sm lang-btn" data-lang="en">üá¨üáß</button>
          <button type="button" class="btn btn-outline-light btn-sm lang-btn" data-lang="ru">üá∑üá∫</button>
        </div>
        <div class="add-post-center">
          <button id="add-post-btn" type="button" class="btn btn-warning btn-sm">+</button>
        </div>
        <div class="text-end">
          <div id="auth-guest" class="d-inline">
            <a href="./register.html" class="btn btn-outline-light me-2" data-i18n="btn_register">Qeydiyyat</a>
            <a href="./login.html" class="btn btn-warning" data-i18n="btn_login">Daxil ol</a>
          </div>
          <div id="auth-user" class="d-none align-items-center gap-2">
            <a href="./profile.html" class="text-white text-decoration-none" aria-label="Profil">
              <img id="header-avatar" class="header-avatar" src="./assets/images/default-profile.png" alt="Profil">
            </a>
            <button id="logout-btn" type="button" class="btn btn-outline-light btn-sm" data-i18n="btn_logout">Log out</button>
          </div>
        </div>
      </div>
    </div>
  </header>
  <hr class="border-light border-2 opacity-75 my-0">

  <main class="container py-5 flex-grow-1">
    <div class="row g-4 align-items-center">
      <div class="col-md-4 text-center">
        <img id="profile-image" src="./assets/images/default-profile.png" alt="Profil ≈ü…ôkli" class="profile-avatar">
        <div class="mt-3 d-grid gap-2">
          <button id="profile-image-pick" type="button" class="btn btn-outline-light btn-sm" data-i18n="btn_pick_image">≈û…ôkil se√ß</button>
          <input id="profile-image-input" type="file" accept="image/*" class="d-none">
          <button id="profile-image-remove" type="button" class="btn btn-outline-danger btn-sm" data-i18n="btn_remove_image">≈û…ôkli sil</button>
        </div>
      </div>
      <div class="col-md-8">
        <h1 class="h3 mb-3" data-i18n="profile_title">Profil</h1>
        <div class="card text-bg-dark border-light">
          <div class="card-body">
            <p class="mb-2"><strong data-i18n="label_name">Ad</strong>: <span id="profile-name">-</span></p>
            <p class="mb-2"><strong data-i18n="label_email">Email</strong>: <span id="profile-email">-</span></p>
            <p class="mb-2"><strong data-i18n="label_phone">Telefon</strong>: <span id="profile-phone">-</span></p>
            <p class="mb-2"><strong data-i18n="label_created">Profilin yaradƒ±ldƒ±ƒüƒ± tarix</strong>: <span id="profile-created">-</span></p>
            <p class="mb-0"><strong data-i18n="label_role">Rol</strong>: <span id="profile-role">-</span></p>
          </div>
        </div>
        <div class="mt-3">
          <button id="profile-edit-btn" type="button" class="btn btn-outline-light btn-sm" data-i18n="btn_edit_profile">M…ôlumatlarƒ± d√ºz…ôlt</button>
        </div>
        <div id="profile-edit-form" class="card text-bg-dark border-light mt-3 d-none">
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label" for="edit-name" data-i18n="label_name">Ad</label>
              <input id="edit-name" class="form-control" type="text">
            </div>
            <div class="mb-3">
              <label class="form-label" for="edit-phone" data-i18n="label_phone">Telefon</label>
              <input id="edit-phone" class="form-control" type="tel" placeholder="+994 50 123 45 67">
            </div>
            <div class="d-flex gap-2">
              <button id="profile-save-btn" type="button" class="btn btn-warning btn-sm" data-i18n="btn_save">Yadda saxla</button>
              <button id="profile-cancel-btn" type="button" class="btn btn-outline-light btn-sm" data-i18n="btn_cancel">L…ôƒüv et</button>
            </div>
          </div>
        </div>
        <div id="profile-message" class="mt-3 text-warning"></div>
      </div>
    </div>

    <hr class="my-5">

    <section>
      <h2 class="h4 mb-3" data-i18n="posts_title">Payla≈üƒ±mlar</h2>
      <div id="posts-list" class="row g-3"></div>
    </section>
  </main>
  <div id="app-toast" class="app-toast"></div>

  <hr class="border-light border-2 opacity-75 my-0">
  <footer class="bg-dark text-white py-3 mt-auto">
    <div class="container">
            <div class="footer-contact mb-3">
        <div class="footer-contact-label">∆èlaq…ô √º√ß√ºn:</div>
        <div class="footer-contact-row">
          <input class="footer-contact-input form-control form-control-dark text-bg-dark" placeholder="Emailinizi yazƒ±n">
          <input class="footer-contact-message form-control form-control-dark text-bg-dark" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n">
          <button class="footer-contact-send btn btn-warning">G√∂nd…ôr</button>
        </div>
      </div>
      <ul class="nav justify-content-center border-bottom pb-0 mb-0">
        <li class="nav-item"><a href="./index.html" class="nav-link px-2 text-white" data-i18n="nav_home">Home</a></li>
        <li class="nav-item"><a href="./profile.html" class="nav-link px-2 text-white" data-i18n="nav_profile">Profil</a></li>
        <li class="nav-item"><a href="./about.html" class="nav-link px-2 text-white" data-i18n="nav_about">About</a></li>
      </ul>
      <p class="text-center mb-0">¬© 2026 AutoDetail.az</p>
    </div>
  </footer>
  <script>
    const translations = {
      az: {
        nav_home: 'Ana s…ôhif…ô',
        nav_contact: '∆èlaq…ô',
        nav_details: 'Detallar',
        nav_profile: 'Profil',
        nav_about: 'Haqqƒ±mƒ±zda',
        btn_register: 'Qeydiyyat',
        btn_login: 'Daxil ol',
        btn_logout: '√áƒ±xƒ±≈ü',
        btn_pick_image: '≈û…ôkil se√ß',
        btn_remove_image: '≈û…ôkli sil',
        btn_edit_profile: 'M…ôlumatlarƒ± d√ºz…ôlt',
        btn_save: 'Yadda saxla',
        btn_cancel: 'L…ôƒüv et',
        profile_title: 'Profil',
        label_name: 'Ad',
        label_email: 'Email',
        label_phone: 'Telefon',
        label_created: 'Profilin yaradƒ±ldƒ±ƒüƒ± tarix',
        label_role: 'Rol',
        posts_title: 'Payla≈üƒ±mlar',
        posts_empty: 'H…ôl…ô payla≈üƒ±m yoxdur.',
        post_added: '∆èlav…ô olunub',
        msg_login_first: 'Profil m…ôlumatlarƒ± √º√ß√ºn …ôvv…ôlc…ô daxil olun.',
        msg_profile_error: 'Profil m…ôlumatlarƒ±nƒ± almaq olmadƒ±.',
        msg_server_error: 'Server…ô qo≈üulmaq olmadƒ±.',
        msg_upload_error: '≈û…ôkil y√ºkl…ônm…ôdi.',
        msg_remove_error: '≈û…ôkil silinm…ôdi.',
        msg_update_success: 'M…ôlumatlar yenil…ôndi.',
        msg_update_error: 'M…ôlumatlarƒ± yenil…ôm…ôk olmadƒ±.',
        search_frames: ['Axtar', 'Axtar.', 'Axtar..', 'Axtar...']
      },
      en: {
        nav_home: 'Home',
        nav_contact: 'Contact',
        nav_details: 'Details',
        nav_profile: 'Profile',
        nav_about: 'About',
        btn_register: 'Register',
        btn_login: 'Log in',
        btn_logout: 'Log out',
        btn_pick_image: 'Choose image',
        btn_remove_image: 'Remove image',
        btn_edit_profile: 'Edit profile',
        btn_save: 'Save',
        btn_cancel: 'Cancel',
        profile_title: 'Profile',
        label_name: 'Name',
        label_email: 'Email',
        label_phone: 'Phone',
        label_created: 'Profile created',
        label_role: 'Role',
        posts_title: 'Posts',
        posts_empty: 'No posts yet.',
        post_added: 'Added',
        msg_login_first: 'Please log in to view your profile.',
        msg_profile_error: 'Could not load profile data.',
        msg_server_error: 'Could not connect to the server.',
        msg_upload_error: 'Image upload failed.',
        msg_remove_error: 'Image could not be removed.',
        msg_update_success: 'Profile updated.',
        msg_update_error: 'Could not update profile.',
        search_frames: ['Search', 'Search.', 'Search..', 'Search...']
      },
      ru: {
        nav_home: '–ì–ª–∞–≤–Ω–∞—è',
        nav_contact: '–ö–æ–Ω—Ç–∞–∫—Ç',
        nav_details: '–î–µ—Ç–∞–ª–∏',
        nav_profile: '–ü—Ä–æ—Ñ–∏–ª—å',
        nav_about: '–û –Ω–∞—Å',
        btn_register: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',
        btn_login: '–í–æ–π—Ç–∏',
        btn_logout: '–í—ã–π—Ç–∏',
        btn_pick_image: '–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ',
        btn_remove_image: '–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ',
        btn_edit_profile: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å',
        btn_save: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
        btn_cancel: '–û—Ç–º–µ–Ω–∞',
        profile_title: '–ü—Ä–æ—Ñ–∏–ª—å',
        label_name: '–ò–º—è',
        label_email: 'Email',
        label_phone: '–¢–µ–ª–µ—Ñ–æ–Ω',
        label_created: '–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è',
        label_role: '–†–æ–ª—å',
        posts_title: '–ü—É–±–ª–∏–∫–∞—Ü–∏–∏',
        posts_empty: '–ü—É–±–ª–∏–∫–∞—Ü–∏–π –Ω–µ—Ç.',
        post_added: '–î–æ–±–∞–≤–ª–µ–Ω–æ',
        msg_login_first: '–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–æ—Ñ–∏–ª—å.',
        msg_profile_error: '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å.',
        msg_server_error: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É.',
        msg_upload_error: '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –Ω–µ —É–¥–∞–ª–∞—Å—å.',
        msg_remove_error: '–§–æ—Ç–æ –Ω–µ —É–¥–∞–ª–µ–Ω–æ.',
        msg_update_success: '–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω.',
        msg_update_error: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å.',
        search_frames: ['–ü–æ–∏—Å–∫', '–ü–æ–∏—Å–∫.', '–ü–æ–∏—Å–∫..', '–ü–æ–∏—Å–∫...']
      }
    };

    let currentLang = localStorage.getItem('siteLang') || 'az';

    const applyTranslations = () => {
      const dict = translations[currentLang] || translations.az;
      document.documentElement.lang = currentLang;
      document.querySelectorAll('[data-i18n]').forEach((el) => {
        const key = el.getAttribute('data-i18n');
        if (dict[key]) {
          el.textContent = dict[key];
        }
      });
      startSearchAnimation(dict.search_frames || translations.az.search_frames);
      if (!currentUserRaw) {
        messageEl.textContent = dict.msg_login_first;
      }
    };

    let searchTimer;
    const startSearchAnimation = (frames) => {
      const searchInput = document.querySelector('input[type="search"]');
      if (!searchInput) {
        return;
      }
      if (searchTimer) {
        clearInterval(searchTimer);
      }
      let i = 0;
      searchTimer = setInterval(() => {
        searchInput.setAttribute('placeholder', frames[i % frames.length]);
        i += 1;
      }, 500);
    };

    document.querySelectorAll('.lang-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        currentLang = btn.dataset.lang;
        localStorage.setItem('siteLang', currentLang);
        applyTranslations();
        if (profileData) {
          const dict = translations[currentLang] || translations.az;
          if (typeof window.profileRenderFn === 'function') {
            window.profileRenderFn(dict, profileData);
          }
        }
      });
    });

    const addPostBtn = document.getElementById('add-post-btn');
    if (addPostBtn) {
      addPostBtn.addEventListener('click', () => {
        const currentUser = localStorage.getItem('currentUser');
        if (!currentUser) {
          window.location.href = './login.html';
          return;
        }
        window.location.href = './add-post.html';
      });
    }

    const guestEl = document.getElementById('auth-guest');
    const userEl = document.getElementById('auth-user');
    const logoutBtn = document.getElementById('logout-btn');
    const currentUser = localStorage.getItem('currentUser');

    if (currentUser) {
      guestEl.classList.add('d-none');
      userEl.classList.remove('d-none');
      userEl.classList.add('d-inline-flex');
    }

    const adminLinks = document.querySelectorAll('.admin-only');
    const favoritesLinks = document.querySelectorAll('.favorites-only');
    const headerAvatar = document.getElementById('header-avatar');
    const DEFAULT_AVATAR = './assets/images/default-profile.png';
    if (currentUser) {
      const email = JSON.parse(currentUser).email;
      favoritesLinks.forEach((el) => el.classList.remove('d-none'));
      fetch(`/api/profile?email=${encodeURIComponent(email)}`)
        .then((res) => res.json())
        .then((data) => {
          if (headerAvatar) {
            headerAvatar.src = (data.user && data.user.profile_image_url) ? data.user.profile_image_url : DEFAULT_AVATAR;
          }
          if (data.user && String(data.user.role).toLowerCase() === 'admin') {
            adminLinks.forEach((el) => el.classList.remove('d-none'));
          }
        })
        .catch(() => {});
    }

    if (logoutBtn) {
      logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('currentUser');
        window.location.href = './index.html';
      });
    }

    const DEFAULT_PROFILE_IMAGE = './assets/images/default-profile.png';
    let profileData = null;
    const nameEl = document.getElementById('profile-name');
    const emailEl = document.getElementById('profile-email');
    const phoneEl = document.getElementById('profile-phone');
    const roleEl = document.getElementById('profile-role');
    const createdEl = document.getElementById('profile-created');
    const messageEl = document.getElementById('profile-message');
    const toastEl = document.getElementById('app-toast');
    const showToast = (text, type) => {
      if (!toastEl) return;
      toastEl.textContent = text;
      toastEl.className = `app-toast show ${type || ''}`.trim();
      clearTimeout(showToast.timer);
      showToast.timer = setTimeout(() => {
        toastEl.className = 'app-toast';
      }, 2000);
    };
    if (messageEl) {
      const observer = new MutationObserver(() => {
        const text = messageEl.textContent.trim();
        if (!text) return;
        const cls = messageEl.className || '';
        const type = cls.includes('text-danger') ? 'error' : (cls.includes('text-success') ? 'success' : '');
        showToast(text, type);
      });
      observer.observe(messageEl, { childList: true, subtree: true, characterData: true });
    }
    const postsEl = document.getElementById('posts-list');
    const profileImageEl = document.getElementById('profile-image');
    const profileImageInput = document.getElementById('profile-image-input');
    const profileImagePick = document.getElementById('profile-image-pick');
    const profileImageRemove = document.getElementById('profile-image-remove');
    const editBtn = document.getElementById('profile-edit-btn');
    const editForm = document.getElementById('profile-edit-form');
    const editName = document.getElementById('edit-name');
    const editPhone = document.getElementById('edit-phone');
    const saveBtn = document.getElementById('profile-save-btn');
    const cancelBtn = document.getElementById('profile-cancel-btn');

    const currentUserRaw = localStorage.getItem('currentUser');
    if (!currentUserRaw) {
      messageEl.textContent = (translations[currentLang] || translations.az).msg_login_first;
    }

    if (profileImagePick && profileImageInput) {
      profileImagePick.addEventListener('click', () => {
        profileImageInput.click();
      });
    }

    if (profileImageInput) {
      profileImageInput.addEventListener('change', async (event) => {
        const dict = translations[currentLang] || translations.az;
        const currentUserRaw = localStorage.getItem('currentUser');
        if (!currentUserRaw) {
          messageEl.textContent = dict.msg_login_first;
          messageEl.className = 'mt-3 text-warning';
          return;
        }
        const currentUser = JSON.parse(currentUserRaw);
        const file = event.target.files && event.target.files[0];
        if (!file) {
          return;
        }
        const formData = new FormData();
        formData.append('image', file);
        formData.append('email', currentUser.email);

        try {
          const response = await fetch('/api/profile/image', {
            method: 'POST',
            body: formData
          });
          const data = await response.json();
          if (!response.ok) {
            messageEl.textContent = data.error || dict.msg_upload_error;
            messageEl.className = 'mt-3 text-danger';
            return;
          }
          profileImageEl.src = data.image_url;
          messageEl.textContent = '';
        } catch (err) {
          messageEl.textContent = dict.msg_server_error;
          messageEl.className = 'mt-3 text-danger';
        }
      });
    }

    if (currentUserRaw) {
      const currentUser = JSON.parse(currentUserRaw);
      const renderProfile = (dict, data) => {
        const user = data.user;
        nameEl.textContent = user.name || '-';
        emailEl.textContent = user.email || '-';
        phoneEl.textContent = user.phone || '-';
        roleEl.textContent = user.role || '-';
        createdEl.textContent = user.created_at
          ? new Date(user.created_at).toLocaleDateString(currentLang === 'ru' ? 'ru-RU' : 'az-AZ')
          : '-';
        if (editName) editName.value = user.name || '';
        if (editPhone) editPhone.value = user.phone || '';

        if (user.profile_image_url) {
          profileImageEl.src = user.profile_image_url;
        } else {
          profileImageEl.src = DEFAULT_PROFILE_IMAGE;
        }

        const posts = data.posts || [];
        if (posts.length === 0) {
          postsEl.innerHTML = `<div class="col-12 text-body-secondary">${dict.posts_empty}</div>`;
          return;
        }

          postsEl.innerHTML = posts
            .map(
              (post) => `
            <div class="col-md-4">
              <div class="card h-100" style="cursor:pointer" onclick="window.location.href='./post.html?id=${post.id}'">
                ${post.image_url ? `<img src="${post.image_url}" class="card-img-top" alt="Payla≈üƒ±m">` : ''}
                <div class="card-body">
                  <h3 class="h6 mb-1">${post.title || 'Payla≈üƒ±m'}</h3>
                  <p class="text-body-secondary mb-2">${post.part_type || ''}</p>
                  <p class="text-body-secondary mb-0">${dict.post_added}: ${new Date(post.created_at).toLocaleDateString(currentLang === 'ru' ? 'ru-RU' : 'az-AZ')}</p>
                </div>
              </div>
            </div>
          `
            )
            .join('');
      };
      window.profileRenderFn = renderProfile;

      fetch(`/api/profile?email=${encodeURIComponent(currentUser.email)}`)
        .then((res) => res.json().then((data) => ({ ok: res.ok, data })))
        .then(({ ok, data }) => {
          const dict = translations[currentLang] || translations.az;
          if (!ok) {
            messageEl.textContent = data.error || dict.msg_profile_error;
            return;
          }
          profileData = data;
          renderProfile(dict, profileData);
        })
        .catch(() => {
          messageEl.textContent = (translations[currentLang] || translations.az).msg_server_error;
        });

      profileImageRemove.addEventListener('click', async () => {
        const dict = translations[currentLang] || translations.az;
        try {
          const response = await fetch(`/api/profile/image?email=${encodeURIComponent(currentUser.email)}`, {
            method: 'DELETE'
          });
          const data = await response.json();
          if (!response.ok) {
            messageEl.textContent = data.error || dict.msg_remove_error;
            return;
          }
          profileImageEl.src = DEFAULT_PROFILE_IMAGE;
          profileImageInput.value = '';
          messageEl.textContent = '';
        } catch (err) {
          messageEl.textContent = dict.msg_server_error;
        }
      });

      if (editBtn && editForm) {
        editBtn.addEventListener('click', () => {
          editForm.classList.toggle('d-none');
        });
      }

      if (cancelBtn && editForm) {
        cancelBtn.addEventListener('click', () => {
          editForm.classList.add('d-none');
        });
      }

      if (saveBtn) {
        saveBtn.addEventListener('click', async () => {
          const dict = translations[currentLang] || translations.az;
          const payload = {
            email: currentUser.email,
            name: (editName && editName.value) ? editName.value.trim() : '',
            phone: (editPhone && editPhone.value) ? editPhone.value.trim() : ''
          };

          if (!payload.name) {
            messageEl.textContent = dict.msg_update_error;
            messageEl.className = 'mt-3 text-danger';
            return;
          }

          try {
            const response = await fetch('/api/profile', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            const data = await response.json();
            if (!response.ok) {
              messageEl.textContent = data.error || dict.msg_update_error;
              messageEl.className = 'mt-3 text-danger';
              return;
            }
            profileData.user = data.user;
            renderProfile(dict, profileData);
            messageEl.textContent = dict.msg_update_success;
            messageEl.className = 'mt-3 text-success';
            editForm.classList.add('d-none');
            const currentUserRaw = localStorage.getItem('currentUser');
            if (currentUserRaw) {
              const stored = JSON.parse(currentUserRaw);
              stored.name = data.user.name;
              localStorage.setItem('currentUser', JSON.stringify(stored));
            }
          } catch (err) {
            messageEl.textContent = dict.msg_update_error;
            messageEl.className = 'mt-3 text-danger';
          }
        });
      }
    }

    applyTranslations();
  </script>
  <script src="./assets/contact.js?v=4"></script>
  <script src="./assets/header-avatar.js?v=3"></script>
</body>

</html>
